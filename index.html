<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mittelman Associates LLP - Holiday Booking System</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      color: #333333;
      min-height: 100vh;
    }

    /* Login Screen */
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
    }

    .login-screen.hidden {
      display: none;
    }

    .login-box {
      background: #ffffff;
      padding: 48px;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    .login-logo {
      background: #C4D600;
      padding: 16px 24px;
      display: inline-block;
      margin-bottom: 24px;
    }

    .login-logo-text {
      font-family: 'Times New Roman', serif;
      font-size: 20px;
      letter-spacing: 3px;
      color: #1a1a1a;
    }

    .login-logo-sub {
      font-family: 'Times New Roman', serif;
      font-size: 12px;
      letter-spacing: 2px;
      color: #1a1a1a;
      margin-top: 4px;
    }

    .login-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .login-subtitle {
      color: #666;
      margin-bottom: 32px;
      font-size: 14px;
    }

    .password-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 16px;
      text-align: center;
      letter-spacing: 2px;
    }

    .password-input:focus {
      outline: none;
      border-color: #C4D600;
    }

    .btn-login {
      width: 100%;
      padding: 14px 28px;
      background: #C4D600;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      color: #1a1a1a;
    }

    .btn-login:hover {
      background: #b3c500;
    }

    .login-error {
      background: #fee2e2;
      color: #dc2626;
      padding: 12px;
      border-radius: 6px;
      margin-top: 16px;
      font-size: 14px;
      display: none;
    }

    .login-error.show {
      display: block;
    }

    /* Main App */
    .app-container {
      display: none;
    }

    .app-container.active {
      display: block;
    }

    .header {
      background: #C4D600;
      padding: 14px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 3px solid #1a1a1a;
    }

    .logo {
      display: flex;
      align-items: baseline;
      gap: 12px;
    }

    .logo-main {
      font-family: 'Times New Roman', serif;
      font-size: 22px;
      font-weight: 400;
      letter-spacing: 4px;
      color: #1a1a1a;
    }

    .logo-sub {
      font-family: 'Times New Roman', serif;
      font-size: 14px;
      letter-spacing: 3px;
      color: #1a1a1a;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .header-info {
      font-size: 13px;
      color: #1a1a1a;
      font-weight: 500;
    }

    .sync-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #1a1a1a;
      padding: 4px 10px;
      background: rgba(255,255,255,0.5);
      border-radius: 12px;
    }

    .sync-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #166534;
    }

    .sync-dot.syncing {
      background: #ca8a04;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .btn-logout {
      background: rgba(0,0,0,0.1);
      border: 1px solid #1a1a1a;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      color: #1a1a1a;
      font-weight: 500;
    }

    .btn-logout:hover {
      background: rgba(0,0,0,0.2);
    }

    /* Dashboard */
    .dashboard-view {
      padding: 24px 32px;
    }

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .dashboard-title {
      font-size: 24px;
      font-weight: 600;
    }

    .nav-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.15s ease;
      font-family: inherit;
    }

    .btn-primary {
      background: #C4D600;
      color: #1a1a1a;
    }

    .btn-primary:hover {
      background: #b3c500;
    }

    .btn-secondary {
      background: #ffffff;
      color: #333333;
      border: 1px solid #e0e0e0;
    }

    .btn-secondary:hover {
      background: #f5f7fa;
    }

    .btn-nav {
      padding: 8px 14px;
      font-size: 14px;
    }

    .month-display {
      font-size: 16px;
      font-weight: 500;
      min-width: 160px;
      text-align: center;
    }

    /* Wallchart */
    .wallchart {
      background: #ffffff;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }

    .wallchart-header {
      display: flex;
      background: #ffffff;
      border-bottom: 2px solid #e0e0e0;
    }

    .wallchart-name-cell {
      width: 200px;
      min-width: 200px;
      padding: 12px 16px;
      font-size: 13px;
      color: #666;
      border-right: 1px solid #e0e0e0;
    }

    .wallchart-days {
      display: flex;
      flex: 1;
    }

    .wallchart-day-header {
      flex: 1;
      min-width: 36px;
      padding: 8px 4px;
      text-align: center;
      border-right: 1px solid #f0f0f0;
    }

    .wallchart-day-header .day-name {
      font-size: 10px;
      color: #999;
      text-transform: uppercase;
    }

    .wallchart-day-header .day-num {
      font-size: 13px;
      font-weight: 500;
      margin-top: 2px;
    }

    .wallchart-day-header.weekend {
      background: #f9f9f9;
      color: #bbb;
    }

    .wallchart-day-header.weekend .day-num {
      color: #bbb;
    }

    .wallchart-row {
      display: flex;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.15s;
    }

    .wallchart-row:hover {
      background: #fafafa;
    }

    .wallchart-row:last-child {
      border-bottom: none;
    }

    .employee-cell {
      width: 200px;
      min-width: 200px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-right: 1px solid #e0e0e0;
      cursor: pointer;
      transition: background 0.15s;
    }

    .employee-cell:hover {
      background: #F5F8D6;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      background: #C4D600;
      color: #1a1a1a;
      flex-shrink: 0;
    }

    .employee-info {
      flex: 1;
      min-width: 0;
    }

    .employee-name {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .employee-days {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    .day-cell {
      flex: 1;
      min-width: 36px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-right: 1px solid #f0f0f0;
    }

    .day-cell.weekend {
      background: #f9f9f9;
    }

    .day-cell.holiday {
      background: #C4D600;
    }

    .day-cell.holiday::after {
      content: 'üå¥';
      font-size: 14px;
    }

    .legend {
      display: flex;
      gap: 24px;
      margin-top: 16px;
      font-size: 13px;
      color: #666;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-box {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }

    /* Individual View */
    .individual-view {
      display: none;
      height: calc(100vh - 56px);
    }

    .individual-view.active {
      display: flex;
      flex-direction: column;
    }

    .dashboard-view.hidden {
      display: none;
    }

    .individual-header {
      background: #ffffff;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e0e0e0;
    }

    .back-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .btn-back {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #f5f7fa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      transition: all 0.15s;
    }

    .btn-back:hover {
      background: #e8eaed;
    }

    .individual-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .individual-title .avatar {
      width: 44px;
      height: 44px;
      font-size: 16px;
    }

    .individual-title h2 {
      font-size: 20px;
      font-weight: 600;
    }

    .year-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .year-display {
      font-size: 15px;
      font-weight: 500;
      color: #666;
      min-width: 180px;
      text-align: center;
    }

    .btn-book {
      background: #2563eb;
      color: white;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin-left: 12px;
    }

    .btn-book:hover {
      background: #1d4ed8;
    }

    .year-view-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .year-calendar {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(3, auto);
      gap: 12px;
    }

    .month-card {
      background: #ffffff;
      border-radius: 6px;
      padding: 10px;
      border: 1px solid #e8e8e8;
    }

    .month-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1a1a1a;
    }

    .month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
    }

    .month-day-header {
      text-align: center;
      font-size: 9px;
      font-weight: 600;
      color: #999;
      padding: 2px 0;
    }

    .month-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      border-radius: 3px;
      position: relative;
    }

    .month-day.weekend {
      color: #ccc;
    }

    .month-day.holiday {
      background: #C4D600;
      color: #1a1a1a;
      font-weight: 600;
    }

    .month-day.holiday::after {
      content: 'üå¥';
      position: absolute;
      font-size: 6px;
      bottom: 0;
      right: 0;
    }

    .month-day.empty {
      visibility: hidden;
    }

    /* Allowance Sidebar */
    .allowance-sidebar {
      width: 260px;
      background: #ffffff;
      border-left: 1px solid #e0e0e0;
      padding: 16px;
      overflow-y: auto;
    }

    .sidebar-title {
      font-size: 13px;
      font-weight: 600;
      color: #666;
      margin-bottom: 16px;
    }

    .allowance-section {
      background: #f9fafb;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .section-header {
      background: #C4D600;
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .section-content {
      padding: 8px 12px;
    }

    .allowance-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      font-size: 13px;
    }

    .allowance-row.total {
      border-top: 1px solid #e0e0e0;
      margin-top: 6px;
      padding-top: 10px;
      font-weight: 600;
    }

    .allowance-label {
      color: #666;
    }

    .allowance-value {
      font-weight: 500;
    }

    .edit-btn {
      background: none;
      border: none;
      color: #2563eb;
      font-size: 11px;
      cursor: pointer;
      text-decoration: underline;
      margin-left: 6px;
    }

    .remaining-section {
      text-align: center;
      padding: 16px;
      background: #f0fdf4;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    .remaining-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
    }

    .remaining-value {
      font-size: 42px;
      font-weight: 700;
      color: #166534;
    }

    .chart-section {
      background: #f9fafb;
      border-radius: 6px;
      padding: 12px;
    }

    .chart-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 10px;
    }

    .chart-container {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      height: 50px;
      gap: 3px;
    }

    .chart-bar-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
    }

    .chart-bar {
      width: 100%;
      background: #C4D600;
      border-radius: 2px 2px 0 0;
      margin-top: auto;
    }

    .chart-label {
      font-size: 8px;
      color: #999;
      margin-top: 3px;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: #ffffff;
      border-radius: 12px;
      padding: 24px;
      width: 420px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      line-height: 1;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #333;
    }

    .input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .input:focus {
      outline: none;
      border-color: #C4D600;
      box-shadow: 0 0 0 3px rgba(196, 214, 0, 0.2);
    }

    .working-days-info {
      background: #f5f7fa;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
    }

    .modal-actions .btn {
      flex: 1;
    }

    .holidays-list {
      margin-top: 20px;
      border-top: 1px solid #e0e0e0;
      padding-top: 16px;
    }

    .holidays-list h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .holiday-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f9fafb;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .holiday-dates {
      font-size: 13px;
      font-weight: 500;
    }

    .holiday-days {
      font-size: 12px;
      color: #666;
    }

    .btn-delete {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fecaca;
      padding: 4px 10px;
      font-size: 11px;
    }

    .btn-delete:hover {
      background: #fecaca;
    }

    .no-holidays {
      text-align: center;
      padding: 16px;
      color: #999;
      font-size: 13px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <div class="login-logo">
        <div class="login-logo-text">MITTELMAN</div>
        <div class="login-logo-sub">ASSOCIATES LLP</div>
      </div>
      <h1 class="login-title">Holiday Booking System</h1>
      <p class="login-subtitle">Enter the team password to continue</p>
      <input type="password" class="password-input" id="passwordInput" placeholder="Enter password" onkeypress="if(event.key === 'Enter') login()">
      <button class="btn-login" onclick="login()">Sign In</button>
      <div class="login-error" id="loginError">Incorrect password. Please try again.</div>
    </div>
  </div>

  <!-- Main App -->
  <div class="app-container" id="appContainer">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <span class="logo-main">MITTELMAN</span>
        <span class="logo-sub">ASSOCIATES LLP</span>
      </div>
      <div class="header-right">
        <div class="header-info">
          Holiday Year: Jan ‚Äì Dec <span id="currentYear"></span> ‚Ä¢ Office closed Dec 25 ‚Äì Jan 1
        </div>
        <div class="sync-indicator">
          <div class="sync-dot" id="syncDot"></div>
          <span id="syncStatus">Synced</span>
        </div>
        <button class="btn-logout" onclick="logout()">Sign Out</button>
      </div>
    </div>

    <!-- Dashboard View -->
    <div class="dashboard-view" id="dashboardView">
      <div class="dashboard-header">
        <h1 class="dashboard-title">Team Wallchart</h1>
        <div class="nav-controls">
          <button class="btn btn-secondary btn-nav" onclick="navigateWallchartMonth(-1)">‚Üê</button>
          <span class="month-display" id="wallchartMonthDisplay"></span>
          <button class="btn btn-secondary btn-nav" onclick="navigateWallchartMonth(1)">‚Üí</button>
          <button class="btn btn-secondary" onclick="goToToday()" style="margin-left: 8px;">Today</button>
        </div>
      </div>

      <div class="wallchart" id="wallchart"></div>

      <div class="legend">
        <div class="legend-item">
          <div class="legend-box" style="background: #C4D600;"></div>
          <span>Holiday</span>
        </div>
        <div class="legend-item">
          <div class="legend-box" style="background: #f0f0f0;"></div>
          <span>Weekend</span>
        </div>
      </div>
    </div>

    <!-- Individual View -->
    <div class="individual-view" id="individualView">
      <div class="individual-header">
        <div class="back-section">
          <button class="btn-back" onclick="showDashboard()">
            ‚Üê Back to Team
          </button>
          <div class="individual-title">
            <div class="avatar" id="individualAvatar"></div>
            <h2 id="individualName"></h2>
          </div>
        </div>
        <div class="year-nav">
          <button class="btn btn-secondary btn-nav" onclick="navigateYear(-1)">‚Üê</button>
          <span class="year-display" id="yearDisplay"></span>
          <button class="btn btn-secondary btn-nav" onclick="navigateYear(1)">‚Üí</button>
          <button class="btn btn-book" onclick="openBookingModal()">+</button>
        </div>
      </div>

      <div class="year-view-container">
        <div class="year-calendar" id="yearCalendar"></div>

        <div class="allowance-sidebar">
          <div class="sidebar-title">Year end Dec <span id="allowanceYear"></span></div>
          
          <div class="allowance-section">
            <div class="section-header">
              <span>Allowance</span>
              <span>Days</span>
            </div>
            <div class="section-content">
              <div class="allowance-row">
                <span class="allowance-label">
                  Carry forward
                  <button class="edit-btn" onclick="editCarryForward()">Edit</button>
                </span>
                <span class="allowance-value" id="carryForwardValue">0</span>
              </div>
              <div class="allowance-row">
                <span class="allowance-label">Contractual allowance</span>
                <span class="allowance-value" id="contractualAllowance">20</span>
              </div>
              <div class="allowance-row total">
                <span>Total allowance</span>
                <span id="totalAllowance">20</span>
              </div>
            </div>
          </div>

          <div class="allowance-section">
            <div class="section-header">
              <span>Deductions</span>
              <span>Days</span>
            </div>
            <div class="section-content">
              <div class="allowance-row">
                <span class="allowance-label">üå¥ Holiday</span>
                <span class="allowance-value" id="holidayDeductions">0</span>
              </div>
              <div class="allowance-row total">
                <span>Total deductions</span>
                <span id="totalDeductions">0</span>
              </div>
            </div>
          </div>

          <div class="remaining-section">
            <div class="remaining-label">Days remaining</div>
            <div class="remaining-value" id="daysRemaining">20</div>
          </div>

          <div class="chart-section">
            <div class="chart-title">Time off</div>
            <div class="chart-container" id="timeOffChart"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Modal -->
  <div class="modal-overlay hidden" id="bookingModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Book Holiday</h3>
        <button class="modal-close" onclick="closeBookingModal()">√ó</button>
      </div>
      <div class="form-group">
        <label>Start Date</label>
        <input type="date" class="input" id="startDate" onchange="updateWorkingDays()">
      </div>
      <div class="form-group">
        <label>End Date</label>
        <input type="date" class="input" id="endDate" onchange="updateWorkingDays()">
      </div>
      <div class="working-days-info hidden" id="workingDaysInfo">
        <strong id="workingDaysCount">0</strong> working days will be deducted
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeBookingModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmBooking()">Book Holiday</button>
      </div>
      
      <div class="holidays-list" id="holidaysList"></div>
    </div>
  </div>

  <!-- Carry Forward Modal -->
  <div class="modal-overlay hidden" id="carryForwardModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Edit Carry Forward</h3>
        <button class="modal-close" onclick="closeCarryForwardModal()">√ó</button>
      </div>
      <div class="form-group">
        <label>Days carried forward from previous year</label>
        <input type="number" class="input" id="carryForwardInput" min="0" step="0.5">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeCarryForwardModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCarryForward()">Save</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBc9OtJGfGCD6xJtBGRW0X8G57U37f3yF8",
      authDomain: "mittelman-holidays.firebaseapp.com",
      databaseURL: "https://mittelman-holidays-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "mittelman-holidays",
      storageBucket: "mittelman-holidays.firebasestorage.app",
      messagingSenderId: "52835151434",
      appId: "1:52835151434:web:f853c8286276e9b42140b3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Password
    const CORRECT_PASSWORD = 'Holiday1009';

    // Default employee data
    const defaultEmployees = [
      { id: 1, name: 'Michael Mittelman', contractualAllowance: 20, carryForward: 0, holidays: [] },
      { id: 2, name: 'Ady Reeve', contractualAllowance: 20, carryForward: 0, holidays: [] },
      { id: 3, name: 'Nathan King', contractualAllowance: 20, carryForward: 0, holidays: [] },
      { id: 4, name: 'Dalila Duffy', contractualAllowance: 20, carryForward: 0, holidays: [] },
      { id: 5, name: 'Aaron McDonald', contractualAllowance: 20, carryForward: 0, holidays: [] },
      { id: 6, name: 'Oliver Piers', contractualAllowance: 20, carryForward: 0, holidays: [] },
      { id: 7, name: 'Gerson Magoga Jnr', contractualAllowance: 16, carryForward: 0, holidays: [] },
      { id: 8, name: 'Simon Noble', contractualAllowance: 20, carryForward: 0, holidays: [] },
      { id: 9, name: 'Nigel Lock', contractualAllowance: 20, carryForward: 0, holidays: [] },
    ];

    // App state
    let employees = [];
    let wallchartMonth = new Date();
    let selectedYear = new Date().getFullYear();
    let selectedEmployeeId = null;
    let isLoggedIn = false;

    // Check if already logged in (session)
    if (sessionStorage.getItem('mittelman_logged_in') === 'true') {
      isLoggedIn = true;
      showApp();
    }

    // Login function
    window.login = function() {
      const password = document.getElementById('passwordInput').value;
      if (password === CORRECT_PASSWORD) {
        isLoggedIn = true;
        sessionStorage.setItem('mittelman_logged_in', 'true');
        document.getElementById('loginError').classList.remove('show');
        showApp();
      } else {
        document.getElementById('loginError').classList.add('show');
        document.getElementById('passwordInput').value = '';
      }
    };

    window.logout = function() {
      isLoggedIn = false;
      sessionStorage.removeItem('mittelman_logged_in');
      document.getElementById('appContainer').classList.remove('active');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('passwordInput').value = '';
    };

    async function showApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('appContainer').classList.add('active');
      document.getElementById('currentYear').textContent = new Date().getFullYear();
      
      await initializeData();
      setupRealtimeListener();
    }

    async function initializeData() {
      try {
        const snapshot = await get(ref(database, 'employees'));
        if (snapshot.exists()) {
          employees = Object.values(snapshot.val());
        } else {
          employees = defaultEmployees;
          await saveAllData();
        }
        renderWallchart();
      } catch (error) {
        console.error('Error loading data:', error);
        employees = defaultEmployees;
        renderWallchart();
      }
    }

    function setupRealtimeListener() {
      onValue(ref(database, 'employees'), (snapshot) => {
        if (snapshot.exists()) {
          employees = Object.values(snapshot.val());
          renderWallchart();
          if (selectedEmployeeId) {
            renderIndividualView();
          }
          updateSyncStatus('Synced');
        }
      });
    }

    async function saveAllData() {
      updateSyncStatus('Syncing...');
      try {
        const data = {};
        employees.forEach(emp => {
          data[emp.id] = emp;
        });
        await set(ref(database, 'employees'), data);
        updateSyncStatus('Synced');
      } catch (error) {
        console.error('Error saving data:', error);
        updateSyncStatus('Error');
      }
    }

    function updateSyncStatus(status) {
      document.getElementById('syncStatus').textContent = status;
      const dot = document.getElementById('syncDot');
      if (status === 'Syncing...') {
        dot.classList.add('syncing');
      } else {
        dot.classList.remove('syncing');
      }
    }

    // Utility functions
    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').slice(0, 2);
    }

    function calculateWorkingDays(start, end) {
      if (!start || !end) return 0;
      const startDate = new Date(start);
      const endDate = new Date(end);
      let count = 0;
      const current = new Date(startDate);
      
      while (current <= endDate) {
        const dayOfWeek = current.getDay();
        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
          count++;
        }
        current.setDate(current.getDate() + 1);
      }
      return count;
    }

    function getDaysTaken(employee) {
      if (!employee.holidays) return 0;
      return employee.holidays.reduce((total, holiday) => {
        return total + calculateWorkingDays(holiday.start, holiday.end);
      }, 0);
    }

    function getTotalEntitlement(employee) {
      return (employee.contractualAllowance || 20) + (employee.carryForward || 0);
    }

    function getDaysRemaining(employee) {
      return getTotalEntitlement(employee) - getDaysTaken(employee);
    }

    function isDateInHoliday(employee, date) {
      if (!employee.holidays) return false;
      const checkDate = new Date(date);
      checkDate.setHours(0, 0, 0, 0);
      
      return employee.holidays.some(holiday => {
        const start = new Date(holiday.start);
        const end = new Date(holiday.end);
        start.setHours(0, 0, 0, 0);
        end.setHours(0, 0, 0, 0);
        return checkDate >= start && checkDate <= end;
      });
    }

    function getDaysInMonth(date) {
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const days = [];
      
      for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
        days.push(new Date(d));
      }
      return days;
    }

    function formatMonthYear(date) {
      return date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function getHolidayDaysPerMonth(employee, year) {
      const monthDays = Array(12).fill(0);
      if (!employee.holidays) return monthDays;
      
      employee.holidays.forEach(holiday => {
        const start = new Date(holiday.start);
        const end = new Date(holiday.end);
        const current = new Date(start);
        
        while (current <= end) {
          if (current.getFullYear() === year && current.getDay() !== 0 && current.getDay() !== 6) {
            monthDays[current.getMonth()]++;
          }
          current.setDate(current.getDate() + 1);
        }
      });
      
      return monthDays;
    }

    // Render functions
    window.renderWallchart = function() {
      const container = document.getElementById('wallchart');
      const daysInMonth = getDaysInMonth(wallchartMonth);
      const dayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];

      document.getElementById('wallchartMonthDisplay').textContent = formatMonthYear(wallchartMonth);

      let html = `
        <div class="wallchart-header">
          <div class="wallchart-name-cell">Team Member</div>
          <div class="wallchart-days">
            ${daysInMonth.map(day => {
              const isWeekend = day.getDay() === 0 || day.getDay() === 6;
              return `
                <div class="wallchart-day-header ${isWeekend ? 'weekend' : ''}">
                  <div class="day-name">${dayNames[day.getDay()]}</div>
                  <div class="day-num">${day.getDate()}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      employees.forEach(employee => {
        html += `
          <div class="wallchart-row">
            <div class="employee-cell" onclick="showIndividual(${employee.id})">
              <div class="avatar">${getInitials(employee.name)}</div>
              <div class="employee-info">
                <div class="employee-name">${employee.name}</div>
                <div class="employee-days">${getDaysRemaining(employee)} days left</div>
              </div>
            </div>
            <div class="wallchart-days">
              ${daysInMonth.map(day => {
                const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                const isHoliday = isDateInHoliday(employee, day);
                return `<div class="day-cell ${isWeekend ? 'weekend' : ''} ${isHoliday && !isWeekend ? 'holiday' : ''}"></div>`;
              }).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    };

    window.navigateWallchartMonth = function(direction) {
      wallchartMonth.setMonth(wallchartMonth.getMonth() + direction);
      renderWallchart();
    };

    window.goToToday = function() {
      wallchartMonth = new Date();
      renderWallchart();
    };

    window.showIndividual = function(employeeId) {
      selectedEmployeeId = employeeId;
      selectedYear = new Date().getFullYear();
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById('individualView').classList.add('active');
      renderIndividualView();
    };

    window.showDashboard = function() {
      document.getElementById('individualView').classList.remove('active');
      document.getElementById('dashboardView').classList.remove('hidden');
      selectedEmployeeId = null;
      renderWallchart();
    };

    window.renderIndividualView = function() {
      const employee = employees.find(e => e.id === selectedEmployeeId);
      if (!employee) return;

      document.getElementById('individualAvatar').textContent = getInitials(employee.name);
      document.getElementById('individualName').textContent = employee.name;
      document.getElementById('yearDisplay').textContent = `January to December ${selectedYear}`;
      document.getElementById('allowanceYear').textContent = selectedYear;

      document.getElementById('carryForwardValue').textContent = employee.carryForward || 0;
      document.getElementById('contractualAllowance').textContent = employee.contractualAllowance || 20;
      document.getElementById('totalAllowance').textContent = getTotalEntitlement(employee);
      document.getElementById('holidayDeductions').textContent = getDaysTaken(employee);
      document.getElementById('totalDeductions').textContent = getDaysTaken(employee);
      document.getElementById('daysRemaining').textContent = getDaysRemaining(employee);

      renderYearCalendar(employee);
      renderTimeOffChart(employee);
    };

    function renderYearCalendar(employee) {
      const container = document.getElementById('yearCalendar');
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                      'July', 'August', 'September', 'October', 'November', 'December'];
      const dayHeaders = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

      let html = '';

      months.forEach((monthName, monthIndex) => {
        const firstDay = new Date(selectedYear, monthIndex, 1);
        const lastDay = new Date(selectedYear, monthIndex + 1, 0);
        const startDay = firstDay.getDay();
        const adjustedStartDay = startDay === 0 ? 6 : startDay - 1;
        const totalDays = lastDay.getDate();

        html += `
          <div class="month-card">
            <div class="month-name">${monthName}</div>
            <div class="month-grid">
              ${dayHeaders.map(d => `<div class="month-day-header">${d}</div>`).join('')}
              ${Array(adjustedStartDay).fill('<div class="month-day empty"></div>').join('')}
              ${Array.from({length: totalDays}, (_, i) => {
                const day = i + 1;
                const date = new Date(selectedYear, monthIndex, day);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const isHoliday = isDateInHoliday(employee, date);
                return `<div class="month-day ${isWeekend ? 'weekend' : ''} ${isHoliday && !isWeekend ? 'holiday' : ''}">${day}</div>`;
              }).join('')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function renderTimeOffChart(employee) {
      const container = document.getElementById('timeOffChart');
      const monthLabels = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
      const monthDays = getHolidayDaysPerMonth(employee, selectedYear);
      const maxDays = Math.max(...monthDays, 5);

      container.innerHTML = monthLabels.map((label, i) => {
        const height = monthDays[i] > 0 ? (monthDays[i] / maxDays) * 35 : 0;
        return `
          <div class="chart-bar-wrapper">
            <div class="chart-bar" style="height: ${height}px;"></div>
            <div class="chart-label">${label}</div>
          </div>
        `;
      }).join('');
    }

    window.navigateYear = function(direction) {
      selectedYear += direction;
      renderIndividualView();
    };

    // Booking functions
    window.openBookingModal = function() {
      document.getElementById('bookingModal').classList.remove('hidden');
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('workingDaysInfo').classList.add('hidden');
      renderHolidaysList();
    };

    window.closeBookingModal = function() {
      document.getElementById('bookingModal').classList.add('hidden');
    };

    window.updateWorkingDays = function() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      
      if (start) {
        document.getElementById('endDate').min = start;
      }
      
      if (start && end) {
        const days = calculateWorkingDays(start, end);
        document.getElementById('workingDaysCount').textContent = days;
        document.getElementById('workingDaysInfo').classList.remove('hidden');
      } else {
        document.getElementById('workingDaysInfo').classList.add('hidden');
      }
    };

    window.confirmBooking = async function() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      
      if (!start || !end) {
        alert('Please select both start and end dates.');
        return;
      }

      const employee = employees.find(e => e.id === selectedEmployeeId);
      const workingDays = calculateWorkingDays(start, end);
      
      if (workingDays > getDaysRemaining(employee)) {
        alert('Not enough holiday days remaining!');
        return;
      }

      if (!employee.holidays) {
        employee.holidays = [];
      }

      employee.holidays.push({
        start: start,
        end: end,
        id: Date.now(),
        bookedAt: new Date().toISOString()
      });

      await saveAllData();
      renderIndividualView();
      renderHolidaysList();
      
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('workingDaysInfo').classList.add('hidden');
    };

    window.renderHolidaysList = function() {
      const employee = employees.find(e => e.id === selectedEmployeeId);
      const container = document.getElementById('holidaysList');

      if (!employee || !employee.holidays || employee.holidays.length === 0) {
        container.innerHTML = '<div class="no-holidays">No holidays booked yet</div>';
        return;
      }

      container.innerHTML = `
        <h4>Booked Holidays</h4>
        ${employee.holidays.map(h => `
          <div class="holiday-item">
            <div>
              <div class="holiday-dates">üå¥ ${formatDate(h.start)} ‚Äì ${formatDate(h.end)}</div>
              <div class="holiday-days">${calculateWorkingDays(h.start, h.end)} working days</div>
            </div>
            <button class="btn btn-delete" onclick="deleteHoliday(${h.id})">Delete</button>
          </div>
        `).join('')}
      `;
    };

    window.deleteHoliday = async function(holidayId) {
      const employee = employees.find(e => e.id === selectedEmployeeId);
      employee.holidays = employee.holidays.filter(h => h.id !== holidayId);
      await saveAllData();
      renderIndividualView();
      renderHolidaysList();
    };

    // Carry forward
    window.editCarryForward = function() {
      const employee = employees.find(e => e.id === selectedEmployeeId);
      document.getElementById('carryForwardInput').value = employee.carryForward || 0;
      document.getElementById('carryForwardModal').classList.remove('hidden');
    };

    window.closeCarryForwardModal = function() {
      document.getElementById('carryForwardModal').classList.add('hidden');
    };

    window.saveCarryForward = async function() {
      const value = parseFloat(document.getElementById('carryForwardInput').value) || 0;
      const employee = employees.find(e => e.id === selectedEmployeeId);
      employee.carryForward = Math.max(0, value);
      
      await saveAllData();
      closeCarryForwardModal();
      renderIndividualView();
    };
  </script>
</body>
</html>
